#%%
import os
import sys
import numpy as np
import matplotlib.pyplot as plt

sys.path.append(os.path.dirname(os.path.realpath(__file__)) + "/../")
from utils.viz.viz import set_3d_axes_equal

#%%
if False:

    pts_model = np.array([[ 44.06208261,   7.22079378,   0.51933249],
        [ 25.74010057,   4.884298  ,  -0.19949603],
        [ 26.31155159,   4.90588849,  -0.23693328],
        [  3.07242228,   0.8750483 ,   0.0271775 ],
        [-16.71022616,  -2.68982967,  -0.14638465],
        [-36.63995554,  -6.47173978,  -0.17685783],
        [-45.83597534,  -8.72445912,   0.2131618 ]])

else:
    pts_model = np.array([[-237.88227843,   14.19840727,    1.79861902],
        [-238.20117536,   14.6614156 ,    1.78242825],
        [-215.33837044,   16.92428191,    0.48747008],
        [-195.69908045,   18.94106712,    0.19122124],
        [-175.35358629,   20.89415701,    0.05274673],
        [-155.52837302,   22.44499131,   -0.19555242],
        [-134.86165305,   24.94670042,   -0.17833737],
        [-114.53049337,   27.10750811,   -0.09080148],
        [ -93.99954486,   29.40996574,   -0.03767748],
        [ -73.77145936,   31.30944608,   -0.20570617],
        [ -53.69518401,   33.39202745,   -0.29034417],
        [ -33.32703155,   35.4456791 ,   -0.36102379],
        [ -13.08181493,   37.37824425,   -0.44670622],
        [   6.96672691,   39.30775907,   -0.50208506],
        [  27.23995404,   41.25950518,   -0.31673683],
        [  47.40761838,   43.19806124,   -0.12792597],
        [  67.59451335,   45.42640713,    0.46189626],
        [  88.03461591,   47.36110606,    0.40507888],
        [ 108.146345  ,   49.77662666,   -0.12134695],
        [ 128.50611721,   51.83644242,    0.15491148],
        [ 147.62350245,   53.94533182,    0.36850693],
        [ 147.58474558,   53.41550521,    0.3958381 ],
        [ 150.0582258 ,   31.56399155,    0.45410715],
        [ 149.71861934,   30.65084394,    0.30628051],
        [ 127.0277893 ,   28.31486753,    0.15388976],
        [ 106.68165989,   26.59223941,   -0.03281673],
        [  86.32563917,   24.60498537,   -0.19089537],
        [  65.95098241,   22.70714186,   -0.25038421],
        [  45.87464149,   20.42172861,   -0.27581029],
        [  25.68496547,   18.22425708,   -0.31109859],
        [   5.1749001 ,   16.14987779,   -0.29424194],
        [ -14.86767866,   14.10398853,   -0.29271025],
        [ -34.84412313,   11.66843952,   -0.36323859],
        [ -54.99754378,    9.50247527,   -0.42574218],
        [ -75.33420723,    7.79792488,   -0.288003  ],
        [ -95.74182401,    5.61283708,   -0.19879219],
        [-115.84771446,    3.4726867 ,   -0.09813477],
        [-136.43592217,    1.47014625,    0.01756614],
        [-156.78271775,   -0.58085487,    0.10737016],
        [-176.91775267,   -2.70719525,    0.24918895],
        [-197.14832003,   -4.8890493 ,    0.33947925],
        [-217.01092991,   -6.9682406 ,    0.43153543],
        [-220.5280712 ,   -7.77539902,    0.43178849],
        [-205.84723884,  -24.99792741,    0.49540383],
        [-202.57257791,  -28.48486645,    0.35635935],
        [ -98.70646267,  -18.35277011,   -0.24235905],
        [ -78.40395563,  -15.88456877,   -0.34313214],
        [ -58.28473205,  -13.65319691,   -0.3984803 ],
        [ -37.59206356,  -11.52652953,   -0.20843575],
        [ -17.41474288,   -9.85137326,   -0.25476905],
        [   2.60199578,   -8.14338831,   -0.41376784],
        [  22.6547723 ,   -6.04978673,   -0.36098514],
        [  43.00722878,   -3.81107751,   -0.32563494],
        [  63.4653204 ,   -1.43931443,   -0.24163921],
        [  83.77079534,    0.67771262,   -0.19244796],
        [ 104.18061005,    2.9985442 ,   -0.00398227],
        [ 124.53015514,    5.47513119,    0.33766027],
        [ 144.77055464,    7.27834886,    0.14260926],
        [ 152.69952988,    8.29279862,    0.16545531],
        [ 155.2975112 ,  -14.47582655,    0.05943751],
        [ 155.02073184,  -15.26093893,    0.18866267],
        [ 132.07502164,  -17.75350916,    0.14327555],
        [ 111.80438948,  -19.50848066,   -0.03592135],
        [  91.71859803,  -21.8168924 ,   -0.17388449],
        [  71.47803173,  -23.88169195,   -0.30045019],
        [  50.89567611,  -25.35670251,   -0.09375307],
        [  30.88400065,  -27.70802003,   -0.14663652],
        [  10.58582709,  -29.99049366,   -0.24835995],
        [  -9.22612502,  -32.24340051,   -0.30461708],
        [ -29.29392967,  -34.05063981,   -0.29349714],
        [  -1.49476987,  -54.50760864,   -0.18565338],
        [  19.06541137,  -52.46870425,   -0.2362535 ],
        [  39.2558427 ,  -50.33789962,   -0.20557896],
        [  59.47271283,  -48.3073585 ,   -0.11720107],
        [  79.65353018,  -46.36052891,   -0.0913814 ],
        [  99.90856015,  -44.26166128,   -0.07518266],
        [ 160.50286595,  -60.84263852,    0.34980672],
        [ 137.61695572,  -63.45741496,    0.25305958],
        [ 117.37733747,  -65.56946703,    0.13604562],
        [  97.35803767,  -67.51952809,    0.08989957],
        [  77.30988231,  -69.36665865,    0.08251844]])

uu, dd, vv = np.linalg.svd(pts_model)
print(np.max([dd[0] / dd[1], dd[1] / dd[2], dd[0] / dd[2]]))

# %%
plt.figure(figsize=(12,10))
ax = plt.axes(projection='3d')
ax.scatter3D(pts_model[:,0], pts_model[:,1], pts_model[:,2], c='r', s=50)
set_3d_axes_equal(ax)

linepts = vv[0] * pts_model[:, 0][:, np.newaxis]
ax.plot(linepts[:,0], linepts[:,1], linepts[:,2])
fitt_line = lambda t: t*vv[0]
ax.plot(linepts[:,0], linepts[:,1], linepts[:,2])
p1 = fitt_line(-1)
p2 = fitt_line(1)
ax.plot([p1[0], p2[0]], [p1[1], p2[1]], [p1[2], p2[2]])

# max_d = 0
# for k in range(pts_model.shape[0]):
#     p0 = pts_model[k, :]
#     d = np.linalg.norm(np.cross(p0-p1, p0-p2)) / np.linalg.norm(p2-p1)
#     max_d = d if d > max_d else max_d

# print(max_d)

#d = np.linalg.norm(np.cross(pts_model-p1, pts_model-p2), axis=1) / np.linalg.norm(p2-p1)
d = np.linalg.norm(np.cross(pts_model-vv[0], pts_model+vv[0]), axis=1) / 2
print(d.max())

# %%
plt.scatter(pts_model[:,0], pts_model[:,1])
plt.plot(linepts[:,0], linepts[:,1])
plt.gca().set_aspect('equal')

# %%
